Todo:
  state transition handling in render path (line ~1350) and update path (line ~1100)
